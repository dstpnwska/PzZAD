---
title: "projekt"
author: "Joanna Maciąg, Dominika Stępniewska"
format: 
  html:
    toc: true
    echo: false
    warning: false
    message: false
    self-contained: true
editor: visual
lang: pl
editor_options: 
  chunk_output_type: inline
---

```{r, warning = F, message = F}
library(flextable)
library(DT)
library(tidyverse)
library(ggplot2)
library(lattice)
library(ggpubr)
library(Hotelling)
library(rstatix)
library(knitr)
library(car)
library(gridExtra)
```

## 1. Cel projektu

Celem projektu jest zbadanie jakie czynniki mają wpływ na poziom stresu.

## 2. Opis zbioru badawczego

Zbiór danych [Sleep Health and Lifestyle Dataset](https://www.kaggle.com/datasets/uom190346a/sleep-health-and-lifestyle-dataset) zawiera informacje dotyczące snu i codziennych nawyków. Składa się z 13 kolumn oraz 374 wierszy.

### 2.1. Opis zmiennych

```{r}
#| tbl-cap: Tabela opisu zmiennych 
#| label: tbl-Tabela1
opis_zmiennych <- data.frame(
nazwa_zmiennej <- c("Gender", "Age", "Occupation", "Sleep Duration", "Quality of Sleep", "Physical Activity Level", "Stress Level", "BMI Category", "Blood Pressure", "Heart Rate", "Daily Steps", "Sleep Disorder"),
opis <- c("płeć (Male - mężczyzna, Female - kobieta)", "wiek w latach", "zawód", "czas snu na dobę w godzinach", "subiektywna ocena jakości snu w skali od 1 do 10", "czas dziennej aktywności fizycznej w minutach", "subiektywna ocena doświadczanego poziomu stresu w skali od 1 do 10", "kategoria BMI (Underweight - niedowaga, Normal - waga prawidłowa, Overweight - nadwaga, Obese - otyłość)", "pomiar ciśnienia krwi wyrażany jako ciśnienie skurczowe na ciśnienie rozkurczowe w jednostce milimetrów słupa rtęci", "tętno spoczynkowe w uderzeniach na minutę", "liczba przebywanych dziennie kroków", "występowanie zaburzeń snu (None - brak, Insomnia - bezsenność, Sleep Apnea - bezdech senny)"),
cecha <- c("jakościowa","ilościowa ciągła","jakościowa", "ilościowa","ilościowa","ilościowa","ilościowa","jakościowa", "ilościowa", "ilościowa","ilościowa", "jakościowa"),
skala <- c("normalna","ilorazowa","porządkowa", "ilorazowa","ilorazowa","ilorazowa","ilorazowa","porządkowa", "", "ilorazowa","ilorazowa", "porządkowa"))

colnames(opis_zmiennych) <- c("nazwa zmiennej", "opis","cecha", "skala")

opis_zmiennych_a <- opis_zmiennych %>% flextable() %>% theme_box()
autofit(opis_zmiennych_a)
```

## 3. Przygotowanie danych

```{r}
#| tbl-cap: Zbiór danych Sleep Health and Lifestyle Dataset 
dane_p <- read.csv(".\\Sleep_health_and_lifestyle_dataset.csv", sep = ",")
datatable(dane_p, class = 'cell-border stripe')
```

### 3.1. Braki danych

```{r, results = FALSE}
sum(is.na(dane_p))
```

Zbiór nie zawiera braków danych.

### 3.2. Duplikacja wierszy

```{r, results = FALSE}
sum(duplicated(dane_p))
```

Żadne wiersze w zbiorze danych nie są zduplikowane.

### 3.3. Podstawowe statystyki

```{r}
#| tbl-cap: Tabela podstawowych statystyk
#| label: tbl-Tabela2
miary <- round(data.frame(as.numeric(summary(dane_p$Age)), 
                as.numeric(summary(dane_p$Sleep.Duration)),
                as.numeric(summary(dane_p$Quality.of.Sleep)),
                as.numeric(summary(dane_p$Physical.Activity.Level)),
                as.numeric(summary(dane_p$Stress.Level)),
                as.numeric(summary(dane_p$Heart.Rate)),
                as.numeric(summary(dane_p$Daily.Steps))), 2)


odch <- round(c(sd(dane_p$Age),
                sd(dane_p$Sleep.Duration),
                sd(dane_p$Quality.of.Sleep),
                sd(dane_p$Physical.Activity.Level),
                sd(dane_p$Stress.Level),
                sd(dane_p$Heart.Rate),
                sd(dane_p$Daily.Steps)), 2)

nazwy <- c("minimum", "kwantyl pierwszy", "mediana", "średnia", "kwantyl trzeci", "maximum", "odchylenie standardowe")

miary1 <- rbind.data.frame(miary,odch)
miary2 <- cbind.data.frame(nazwy, miary1)

colnames(miary2) <-c("Basic Statistic","Age","Sleep Duration", "Quality of Sleep", "Physical Activity Level", "Stress Level", "Heart Rate", "Daily Steps")

flextable(miary2) %>% theme_box()
```

Z powyższej @tbl-Tabela2 możemy odczytać podstawowe statystyki, które w kolejnym etapie posłużą nam do analizy elementów odstających.

Zauważamy, że różnica między średnią a medianą w każdej z kolumn jest niewielka. Podobnie w przypadku kwantyli, kwantyl pierwszy $(Q_1)$ i kwantyl trzeci $(Q_3)$ są równo oddalone od mediany, zatem oznacza to że rozkład danych jest symetryczny.

### 3.4. Elementy odstające

```{r}
dane1 <- data.frame(dane_p$Age, dane_p$Sleep.Duration, dane_p$Quality.of.Sleep, dane_p$Physical.Activity.Level, dane_p$Stress.Level, dane_p$Heart.Rate, dane_p$Daily.Steps)

colnames(dane1) <-c("Age","Sleep Duration", "Quality of Sleep", "Physical Activity Level", "Stress Level", "Heart Rate", "Daily Steps")

dane_md <- dane1 %>% 
  group_by("Stress Level") %>% 
  mahalanobis_distance()
```

Do zidentyfikowania elemnetów odstających posłużyłyśmy się odległością Mahalanobisa. Niska wartość tej odległości mówi o tym, jak dany punkt jest blisko centrum rozkładu. Natomiast wysoka wartość jak dany punkt jest daleko od centrum rozkładu.

```{r}
#| tbl-cap: Tabela elementów odstających 
#| label: tbl-Tabela3
dane_sort <- dane_md[order(dane_md$is.outlier=="FALSE"),]
dane_sort <- head(dane_sort, 9)

names(dane_sort) <- c("Age","Sleep Duration", "Quality of Sleep", "Physical Activity Level", "Stress Level", "Heart Rate", "Daily Steps", "Mahalanobis Distance", "Outlier")

Id <- c(4,5,6,51,52,94,146,277,278)

dane_sort <- cbind(Id,dane_sort)
flextable(dane_sort) %>% 
  theme_box()
```

W naszym zbiorze wartości zbliżone do 23 są uważane za normalne. Wynika z tego, że odległości większe od 23 wskazują elementy odstające. Co przedstawia powyższa @tbl-Tabela3.

W kolejnym kroku usuwamy elementy odstające, aby ułatwić pracę na zbiorze.

```{r}
rows_to_delete <- which(dane_md$is.outlier==1)
dane <- dane_p[-rows_to_delete,]
```

### 3.5. Poprawność danych

Zmienna 'BMI Category' przyjmuje wartość 'Normal Weight', która nie jest zamieszczona w opisie zmiennych przygotowanym przez autorów zbioru danych. Zamieniamy tę wartość na wartość 'Underweight', która nie występuje we wczytanym zbiorze, natomiast jest uwzględniona w opisie.

```{r}
dane$BMI.Category <- dane$BMI.Category %>% str_replace("Normal Weight", "Underweight")
```

## 4. Analiza zbioru badawczego

### 4.1. Rozkłady zmiennych

Poniższe wykresy przedstawiają rozkłady zmiennych.

```{r}
dane_l1 <- data.frame(dane$Quality.of.Sleep, dane$Stress.Level)
names(dane_l1) <- c("Quality of Sleep", "Stress Level")
dane_long1 <- pivot_longer(dane_l1, cols = everything(), names_to = "Zmienna", values_to = "Wartosc")
```

```{r}
#| label: fig-slupkowe1
#| fig-cap: Wykresy słupkowe zmiennych jakościowych Quality of Sleep i Stress Level

ggplot(dane_long1, aes(x = Wartosc)) +
  geom_bar(fill = "royal blue 1", position = "identity", alpha = 0.7) +
  labs(x = "Wartość", y = "Częstość") +
  facet_wrap(~Zmienna, scales = "free") +
  theme_minimal()
```

```{r}
slp1 <- ggplot(dane, aes(x = Gender)) +
  geom_bar(fill = "royal blue 1", color = "white", alpha = 0.7) +
  ylab("Liczność") +
  ggtitle("Gender") +
  ylim(c(0,200)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        plot.title = element_text(size = 9, hjust = 0.5),
        axis.title.x = element_blank())

slp2 <- ggplot(dane, aes(x = Occupation)) +
  geom_bar(fill = "royal blue 1", color = "white", alpha = 0.7) +
  ylab("Liczność") +
  ggtitle("Occupation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        plot.title = element_text(size = 9, hjust = 0.5),
        axis.title.x = element_blank())

slp3 <- ggplot(dane, aes(x = BMI.Category)) +
  geom_bar(fill = "royal blue 1", color = "white", alpha = 0.7) +
  ylab("Liczność") +
  ggtitle("BMI Category") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        plot.title = element_text(size = 9, hjust = 0.5),
        axis.title.x = element_blank())
  
slp4 <- ggplot(dane, aes(x = Sleep.Disorder)) +
  geom_bar(fill = "royal blue 1", color = "white", alpha = 0.7) +
  ylab("Liczność") +
  ggtitle("Sleep Disorder") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        plot.title = element_text(size = 9, hjust = 0.5),
        axis.title.x = element_blank())
```

```{r}
#| label: fig-slupkowe2
#| fig-cap: Histogram zmiennej jakościowej Occupation

slp2
```

```{r}
#| label: fig-slupkowe3
#| fig-cap: Wykresy słupkowe zmiennych jakościowych Gender, BMI Category i Sleep Disorder

grid.arrange(slp1, slp3, slp4, ncol = 3)
```

```{r}
binwidth1 <- (2 * IQR(dane$Age)) / (length(dane$Age)^(1/3))
his1 <- ggplot(dane, aes(x = Age)) +
  geom_histogram(fill = "royal blue 1", color = "white", binwidth = binwidth1, position = "identity", alpha = 0.7) +
  labs(title = "Age", x = "Wartość", y = "Częstość") +
  theme_minimal() +
  theme(plot.title = element_text(size = 9, hjust = 0.5))

binwidth2 <- (2 * IQR(dane$Sleep.Duration)) / (length(dane$Sleep.Duration)^(1/3))
his2 <- ggplot(dane, aes(x = Sleep.Duration)) +
  geom_histogram(fill = "royal blue 1", color = "white", binwidth = binwidth2, position = "identity", alpha = 0.7) +
  labs(title = "Sleep Duration", x = "Wartość", y = "Częstość") +
  theme_minimal() +
  theme(plot.title = element_text(size = 9, hjust = 0.5))

binwidth3 <- (2 * IQR(dane$Physical.Activity.Level)) / (length(dane$Physical.Activity.Level)^(1/3))
his3 <- ggplot(dane, aes(x = Physical.Activity.Level)) +
  geom_histogram(fill = "royal blue 1", color = "white", binwidth = binwidth3, position = "identity", alpha = 0.7) +
  labs(title = "Physical Activity Level", x = "Wartość", y = "Częstość") +
  theme_minimal() +
  theme(plot.title = element_text(size = 9, hjust = 0.5))

binwidth4 <- (2 * IQR(dane$Heart.Rate)) / (length(dane$Heart.Rate)^(1/3))
his4 <- ggplot(dane, aes(x = Heart.Rate)) +
  geom_histogram(fill = "royal blue 1", color = "white", binwidth = binwidth4, position = "identity", alpha = 0.7) +
  labs(title = "Heart Rate", x = "Wartość", y = "Częstość") +
  theme_minimal() +
  theme(plot.title = element_text(size = 9, hjust = 0.5))

binwidth5 <- (2 * IQR(dane$Daily.Steps)) / (length(dane$Daily.Steps)^(1/3))
his5 <- ggplot(dane, aes(x = Daily.Steps)) +
  geom_histogram(fill = "royal blue 1", color = "white", binwidth = binwidth5, position = "identity", alpha = 0.7) +
  labs(title = "Daily Steps", x = "Wartość", y = "Częstość") +
  theme_minimal() +
  theme(plot.title = element_text(size = 9, hjust = 0.5))
```

```{r}
#| label: fig-histogramy1
#| fig-cap: Histogramy zmiennych ilościowych Age i Sleep Duration

grid.arrange(his1, his2, ncol = 2)
```

```{r}
#| label: fig-histogramy2
#| fig-cap: Histogramy zmiennych ilościowych Physical Activity Level, Heart Rate i Daily Steps

grid.arrange(his3, his4, his5, ncol = 3)
```

Szerokości przedziałów w histogramach @fig-histogramy1 i @fig-histogramy2 zostały dobrane zgodnie z regułą Freedmana-Diaconisa:

$$
binwidth = \frac{2\cdot IQR(x)}{\sqrt[3]{n}}
$$

gdzie $IQR(x)$ to zakres międzykwartylowy, a $n$ - liczba obserwacji.

### 4.2. Dodać tytuł

```{r, message = F}
dane2 <- dane %>%
  group_by(Gender, Sleep.Disorder) %>%
  dplyr::summarise(count = n())
```

```{r}
#| label: fig-disorder_gender
#| fig-cap: Wykres liczby osób z zaburzeniami snu w podziale na płeć

ggplot(dane2, aes(x = Sleep.Disorder, y = count, fill = Gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Zaburzenie snu", y = "Liczba osób") +
  scale_fill_brewer(palette = "Set2", name = "Płeć") +
  theme_minimal()
```

Z wykresu wynika, że zaburzenie snu zależy od płci. Naszą obserwację potwierdzimy **testem niezależności chi-kwadrat**.

Hipoteza zerowa $(H_0)$: zaburzenie snu i płeć są niezależne

Hipoteza alternatywna $(H_1)$: zaburzenie snu i płeć nie są niezależne

```{r}
chisq.test(table(dane$Sleep.Disorder, dane$Gender))
```

Wartość $p$ jest mniejsza niż przyjęty poziom istotności $0.05$, więc odrzucamy hipotezę zerową. Możemy więc twierdzić, że istnieje istotna zależność między zmiennymi zaburzenie snu i płeć.

```{r}
#| label: fig-steps_rate
#| fig-cap: Wykres zależności tętna spoczynkowego od liczby przebywanych dziennie kroków

ggplot(data = dane, aes(x = Daily.Steps, y = Heart.Rate)) +
  geom_point() +  
  geom_smooth(method = "loess", se = FALSE, color = "blue") +  
  labs(x = "liczba kroków", y = "tętno spoczynkowe (w uderzeniach na minutę)")
```

```{r}
#| label: fig-bmi_stress
#| fig-cap: Wykres rozkładu odczuwanego poziomu stresu z podziałem na kategorie BMI

ggplot(dane, aes(x = BMI.Category, y = Stress.Level)) +
  geom_boxplot() +
  labs(x = "Kategorie BMI", y = "Poziom stresu") +
  theme_minimal()
```

Przeprowadzimy **test ANOVA**, aby porównać średnie wartości odczuwanego poziomu stresu w kategoriach BMI.

Najpierw sprawdzimy założenia:

1\) Normalność rozkładu

Hipoteza zerowa $(H_0)$: dane pochodzą z populacji o rozkładzie normalnym

Hipoteza alternatywna $(H_1)$: dane pochodzą z populacji o innym rozkładzie niż normalny

```{r}
nor_roz <- dane %>%
  group_by(BMI.Category) %>%
  dplyr::summarise(p_value = shapiro.test(Stress.Level)$p.value)
print(nor_roz)
```

W każdej z grup wartość $p$ jest mniejsza niż przyjęty poziom istotności $0.05$, zatem nie jest spełnione założenie o normalności rozkładu.

2\) Homogeniczność wariancji

Hipoteza zerowa $(H_0)$: wariancje w grupach są równe

Hipoteza alternatywna $(H_1)$: co najmniej jedna z grup ma inną wariancję niż pozostałe

```{r, warning = F}
leveneTest(Stress.Level ~ BMI.Category, data = dane)
```

Wartość $p$ jest mniejsza niż przyjęty poziom istotności $0.05$, zatem odrzucamy hipotezę zerową.

Założenia o normalności rozkładu i homogeniczności wariancji nie są spełnione, zatem zastosujemy test Kruskalla-Wallisa.

Hipoteza zerowa $(H_0)$: Nie ma istotnych różnic w medianach wartości poziomu stresu między kategoriami BMI

Hipoteza alternatywna $(H_1)$: Istnieją istotne różnice w medianach wartości poziomu stresu między co najmniej jedną parą kategorii BMI

```{r}
kruskal.test(Stress.Level ~ BMI.Category, data = dane)
```

Wartość $p$ jest większa niż przyjęty poziom istotności $0.05$, zatem nie mamy podstaw do odrzucenia hipotezy zerowej. Oznacza to, że różnice median między grupami nie są istotne statystycznie.

## 5. Budowa modeli klasyfikacyjnych

## 6. Podsumowanie
